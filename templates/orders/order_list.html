{% extends "base.html" %}
{% block page_title %}<h5>주문 내역</h5>{% endblock %}

{% block extra_css %}
<style>
    .filter-chip {
        display: inline-flex; align-items: center;
        padding: 6px 16px; border-radius: 20px;
        font-size: 13px; font-weight: 600;
        text-decoration: none; transition: all 0.15s;
        border: 1px solid var(--toss-gray-200);
        color: var(--toss-gray-600); background: #fff;
    }
    .filter-chip:hover { border-color: var(--toss-blue); color: var(--toss-blue); }
    .filter-chip.active {
        background: var(--toss-blue); color: #fff;
        border-color: var(--toss-blue);
    }
    .toss-pagination {
        display: flex; align-items: center; justify-content: center;
        gap: 4px; margin-top: 20px;
    }
    .toss-pagination a, .toss-pagination span {
        display: inline-flex; align-items: center; justify-content: center;
        width: 36px; height: 36px; border-radius: 10px;
        font-size: 14px; font-weight: 500;
        text-decoration: none; transition: all 0.15s;
        color: var(--toss-gray-600);
    }
    .toss-pagination a:hover { background: var(--toss-gray-100); }
    .toss-pagination .active {
        background: var(--toss-blue); color: #fff; font-weight: 700;
    }
    .toss-pagination .nav-btn {
        width: auto; padding: 0 14px;
        font-size: 13px; font-weight: 600;
    }

    /* 일괄 변경 바 */
    .bulk-bar {
        display: none; position: fixed; bottom: 0; left: var(--sidebar-w); right: 0;
        background: #fff; border-top: 1px solid var(--toss-gray-200);
        padding: 14px 32px; z-index: 999;
        box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
        align-items: center; gap: 16px;
    }
    .bulk-bar.show { display: flex; }
    .bulk-bar .bulk-count {
        font-size: 14px; font-weight: 700; color: var(--toss-blue);
        white-space: nowrap;
    }

    /* 체크박스 */
    .order-check {
        width: 18px; height: 18px; cursor: pointer;
        accent-color: var(--toss-blue);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'orders:order_list' %}" class="filter-chip {% if not current_status %}active{% endif %}">전체</a>
        {% for val, label in status_choices %}
        <a href="?status={{ val }}" class="filter-chip {% if current_status == val %}active{% endif %}">{{ label }}</a>
        {% endfor %}
    </div>
    <a href="{% url 'orders:order_export' %}" class="btn-toss btn-toss-success btn-toss-sm">
        <i class="bi bi-download"></i> 엑셀 다운로드
    </a>
</div>

<div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:#eef4ff;border-radius:12px;margin-bottom:12px;border:1px solid #c7d9f6;">
    <i class="bi bi-megaphone-fill" style="color:var(--toss-blue);font-size:15px;flex-shrink:0"></i>
    <span style="font-size:13px;color:var(--toss-gray-800);font-weight:500">접수 완료 시 관리자에게 주문번호 알려주시면 셋팅 및 진행 도와드리고 있습니다.</span>
</div>
<div class="toss-card" {% if request.user.is_admin %}style="margin-bottom:80px"{% endif %}>
    <div style="overflow-x:auto">
        <table class="toss-table">
            <thead>
                <tr>
                    {% if request.user.is_admin %}<th style="width:40px"><input type="checkbox" class="order-check" id="checkAll"></th>{% endif %}

                    <th>주문번호</th>
                    {% if not request.user.is_seller %}<th>상위계정 / 주문자</th>{% endif %}
                    <th>상품</th>
                    <th>건수</th>
                    {% if not request.user.is_seller %}<th>총 금액</th>{% endif %}
                    <th>상태</th>
                    <th>주문일</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    {% if request.user.is_admin %}
                    <td onclick="event.stopPropagation()">
                        <input type="checkbox" class="order-check order-row-check" value="{{ order.pk }}">
                    </td>
                    {% endif %}
                    <td style="font-weight:600;cursor:pointer" onclick="location.href='{% url 'orders:order_detail' order.pk %}'">{{ order.order_number }}</td>
                    {% if not request.user.is_seller %}<td style="cursor:pointer" onclick="location.href='{% url 'orders:order_detail' order.pk %}'">{% if order.user.parent %}<span style="color:var(--toss-gray-400);font-size:12px">{{ order.user.parent.company_name|default:order.user.parent.username }}</span> / {% endif %}{{ order.user.company_name|default:order.user.username }}</td>{% endif %}
                    <td style="cursor:pointer" onclick="location.href='{% url 'orders:order_detail' order.pk %}'">{{ order.product.name }}</td>
                    <td style="cursor:pointer" onclick="location.href='{% url 'orders:order_detail' order.pk %}'">{{ order.item_count }}건</td>
                    {% if not request.user.is_seller %}<td style="font-weight:600;cursor:pointer" onclick="location.href='{% url 'orders:order_detail' order.pk %}'">{{ order.total_amount|floatformat:0|intcomma }}원</td>{% endif %}
                    <td style="cursor:pointer" onclick="location.href='{% url 'orders:order_detail' order.pk %}'">
                        <span class="toss-badge {% if order.status == 'submitted' %}blue{% elif order.status == 'paid' %}green{% elif order.status == 'processing' %}orange{% elif order.status == 'completed' %}green{% else %}gray{% endif %}">
                            {{ order.get_status_display }}
                        </span>
                    </td>
                    <td style="color:var(--toss-gray-500);cursor:pointer" onclick="location.href='{% url 'orders:order_detail' order.pk %}'">{{ order.created_at|date:"m/d H:i" }}</td>
                    <td style="white-space:nowrap">
                        <a href="{% url 'orders:order_detail' order.pk %}" class="btn-toss btn-toss-light btn-toss-sm" style="padding:4px 10px;font-size:12px">상세</a>
                        {% if request.user.is_admin or request.user.is_manager %}
                        <a href="{% url 'orders:order_detail' order.pk %}" class="btn-toss btn-toss-light btn-toss-sm" style="padding:4px 10px;font-size:12px;color:var(--toss-blue)">수정</a>
                        {% if order.status == 'submitted' %}
                        <form method="post" action="{% url 'orders:order_cancel' order.pk %}" style="display:inline" onsubmit="return confirm('주문 {{ order.order_number }}을(를) 취소하시겠습니까?')">
                            {% csrf_token %}
                            <button type="submit" class="btn-toss btn-toss-light btn-toss-sm" style="padding:4px 10px;font-size:12px;color:var(--toss-red)">취소</button>
                        </form>
                        {% endif %}
                        {% if request.user.is_admin %}
                        <form method="post" action="{% url 'orders:order_delete' order.pk %}" style="display:inline" onsubmit="return confirm('주문 {{ order.order_number }}을(를) 삭제하시겠습니까? 복구할 수 없습니다.')">
                            {% csrf_token %}
                            <button type="submit" class="btn-toss btn-toss-light btn-toss-sm" style="padding:4px 10px;font-size:12px;color:var(--toss-red)">삭제</button>
                        </form>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="9" style="text-align:center;padding:48px;color:var(--toss-gray-400)">주문이 없습니다</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if orders.has_other_pages %}
<div class="toss-pagination">
    {% if orders.has_previous %}
    <a href="?page={{ orders.previous_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}" class="nav-btn">이전</a>
    {% endif %}
    {% for num in orders.paginator.page_range %}
    {% if orders.number == num %}
    <span class="active">{{ num }}</span>
    {% else %}
    <a href="?page={{ num }}{% if current_status %}&status={{ current_status }}{% endif %}">{{ num }}</a>
    {% endif %}
    {% endfor %}
    {% if orders.has_next %}
    <a href="?page={{ orders.next_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}" class="nav-btn">다음</a>
    {% endif %}
</div>
{% endif %}

{% if request.user.is_admin %}
<!-- 일괄 상태 변경 바 -->
<form method="post" action="{% url 'orders:order_bulk_status_update' %}" id="bulkForm">
    {% csrf_token %}
    <div class="bulk-bar" id="bulkBar">
        <span class="bulk-count"><span id="selectedCount">0</span>건 선택</span>
        <select name="status" class="toss-select" style="padding:8px 12px;font-size:13px">
            {% for val, label in status_choices %}
            <option value="{{ val }}">{{ label }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn-toss btn-toss-primary btn-toss-sm">일괄 변경</button>
        <button type="button" class="btn-toss btn-toss-light btn-toss-sm" onclick="clearSelection()">취소</button>
    </div>
</form>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if request.user.is_admin %}
<script>
(function() {
    var checkAll = document.getElementById('checkAll');
    var bulkBar = document.getElementById('bulkBar');
    var bulkForm = document.getElementById('bulkForm');
    var countEl = document.getElementById('selectedCount');
    var rowChecks = document.querySelectorAll('.order-row-check');

    function updateBar() {
        var checked = document.querySelectorAll('.order-row-check:checked');
        countEl.textContent = checked.length;
        if (checked.length > 0) {
            bulkBar.classList.add('show');
        } else {
            bulkBar.classList.remove('show');
        }
    }

    checkAll.addEventListener('change', function() {
        rowChecks.forEach(function(cb) { cb.checked = checkAll.checked; });
        updateBar();
    });

    rowChecks.forEach(function(cb) {
        cb.addEventListener('change', function() {
            checkAll.checked = document.querySelectorAll('.order-row-check:checked').length === rowChecks.length;
            updateBar();
        });
    });

    bulkForm.addEventListener('submit', function(e) {
        var checked = document.querySelectorAll('.order-row-check:checked');
        if (checked.length === 0) { e.preventDefault(); return; }
        // 기존 hidden input 제거
        bulkForm.querySelectorAll('input[name="order_ids"]').forEach(function(el) { el.remove(); });
        checked.forEach(function(cb) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'order_ids';
            input.value = cb.value;
            bulkForm.appendChild(input);
        });
    });

    window.clearSelection = function() {
        checkAll.checked = false;
        rowChecks.forEach(function(cb) { cb.checked = false; });
        updateBar();
    };
})();
</script>
{% endif %}
{% endblock %}
