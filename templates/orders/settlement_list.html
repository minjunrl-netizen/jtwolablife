{% extends "base.html" %}
{% load humanize %}
{% block page_title %}<h5>정산 내역</h5>{% endblock %}

{% block extra_css %}
<style>
    .filter-bar {
        display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    }
    .period-btn {
        padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 600;
        border: 1px solid var(--toss-gray-200); background: #fff; color: var(--toss-gray-600);
        cursor: pointer; transition: all 0.15s;
    }
    .period-btn:hover { border-color: var(--toss-blue); color: var(--toss-blue); }
    .period-btn.active { background: var(--toss-blue); color: #fff; border-color: var(--toss-blue); }
    .toss-pagination {
        display: flex; align-items: center; justify-content: center;
        gap: 4px; margin-top: 20px;
    }
    .toss-pagination a, .toss-pagination span {
        display: inline-flex; align-items: center; justify-content: center;
        width: 36px; height: 36px; border-radius: 10px;
        font-size: 14px; font-weight: 500;
        text-decoration: none; color: var(--toss-gray-600);
        transition: all 0.15s;
    }
    .toss-pagination a:hover { background: var(--toss-gray-100); }
    .toss-pagination .active {
        background: var(--toss-blue); color: #fff; font-weight: 700;
    }
    .toss-pagination .nav-btn {
        width: auto; padding: 0 14px;
        font-size: 13px; font-weight: 600;
    }
    .profit-highlight {
        color: var(--toss-green); font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<!-- 요약 카드 6개 -->
<div class="row g-3 mb-4">
    <div class="col-md-4 col-lg-2">
        <div class="stat-card">
            <div class="stat-label">정산 건수</div>
            <div class="stat-value" style="font-size:22px">{{ summary.total_count|default:0 }}건</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card">
            <div class="stat-label">정산 총액</div>
            <div class="stat-value" style="font-size:22px;color:var(--toss-blue)">{{ summary.total_amount|default:0|intcomma }}원</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card">
            <div class="stat-label">공급가 합계</div>
            <div class="stat-value" style="font-size:22px">{{ summary.total_supply|default:0|intcomma }}원</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card">
            <div class="stat-label">부가세 합계</div>
            <div class="stat-value" style="font-size:22px">{{ summary.total_vat|default:0|intcomma }}원</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card">
            <div class="stat-label">총 감은 타수</div>
            <div class="stat-value" style="font-size:22px">{{ summary.total_reduced_qty|default:0|intcomma }}타</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card" style="border-color:var(--toss-green)">
            <div class="stat-label" style="color:var(--toss-green)">감은 수익 합계</div>
            <div class="stat-value profit-highlight" style="font-size:22px">{{ summary.total_reduced_profit|default:0|intcomma }}원</div>
        </div>
    </div>
</div>

<!-- 필터 -->
<div class="toss-card mb-4">
    <div class="card-body">
        <form method="get" class="filter-bar">
            <button type="submit" name="period" value="month" class="period-btn {% if period == 'month' and not date_from %}active{% endif %}">이번 달</button>
            <button type="submit" name="period" value="all" class="period-btn {% if period == 'all' or date_from %}active{% endif %}">전체</button>
            <span style="color:var(--toss-gray-300)">|</span>
            <input type="date" name="date_from" value="{{ date_from }}" class="toss-input" style="width:160px" placeholder="시작일">
            <span style="color:var(--toss-gray-400);font-size:13px">~</span>
            <input type="date" name="date_to" value="{{ date_to }}" class="toss-input" style="width:160px" placeholder="종료일">
            <button type="submit" name="period" value="all" class="btn-toss btn-toss-primary btn-toss-sm">조회</button>
            <a href="?{{ request.GET.urlencode }}&export=excel" class="btn-toss btn-toss-light btn-toss-sm">
                <i class="bi bi-download"></i> 엑셀 다운로드
            </a>
        </form>
    </div>
</div>

<!-- 정산 테이블 -->
<div class="toss-card">
    <div style="overflow-x:auto">
        <table class="toss-table">
            <thead>
                <tr>
                    <th>업체</th>
                    <th>주문번호</th>
                    <th>상품</th>
                    <th>총타수</th>
                    <th>감은%</th>
                    <th>감은타수</th>
                    <th>실투입</th>
                    <th>공급가</th>
                    <th>부가세</th>
                    <th>총액</th>
                    <th>감은수익</th>
                    <th>승인일</th>
                    <th>상태</th>
                </tr>
            </thead>
            <tbody>
                {% for item in orders %}
                <tr>
                    <td>{{ item.order.user.company_name|default:item.order.user.username }}</td>
                    <td>
                        <a href="{% url 'orders:order_detail' item.order.pk %}" style="color:var(--toss-blue);font-weight:600;text-decoration:none">
                            {{ item.order.order_number }}
                        </a>
                    </td>
                    <td>{{ item.order.product.name }}</td>
                    <td style="font-weight:600">{{ item.total_qty|intcomma }}</td>
                    <td>{{ item.reduction_rate }}%</td>
                    <td style="font-weight:600;color:var(--toss-orange)">{{ item.reduced_qty|intcomma }}</td>
                    <td>{{ item.actual_qty|intcomma }}</td>
                    <td>{{ item.supply|intcomma }}원</td>
                    <td>{{ item.vat|intcomma }}원</td>
                    <td style="font-weight:700">{{ item.order.total_amount|floatformat:0|intcomma }}원</td>
                    <td class="profit-highlight">{{ item.reduced_profit|intcomma }}원</td>
                    <td style="color:var(--toss-gray-500)">
                        {% if item.order.confirmed_at %}
                            {{ item.order.confirmed_at|date:"m/d H:i" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <span class="toss-badge {% if item.order.status == 'paid' %}blue{% elif item.order.status == 'processing' %}orange{% elif item.order.status == 'completed' %}green{% endif %}">
                            {{ item.order.get_status_display }}
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="13" style="text-align:center;padding:48px;color:var(--toss-gray-400)">
                        정산 내역이 없습니다
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if orders.has_other_pages %}
<div class="toss-pagination">
    {% if orders.has_previous %}
    <a href="?page={{ orders.previous_page_number }}&period={{ period }}&date_from={{ date_from }}&date_to={{ date_to }}" class="nav-btn">이전</a>
    {% endif %}
    {% for num in orders.paginator.page_range %}
    {% if orders.number == num %}
    <span class="active">{{ num }}</span>
    {% else %}
    <a href="?page={{ num }}&period={{ period }}&date_from={{ date_from }}&date_to={{ date_to }}">{{ num }}</a>
    {% endif %}
    {% endfor %}
    {% if orders.has_next %}
    <a href="?page={{ orders.next_page_number }}&period={{ period }}&date_from={{ date_from }}&date_to={{ date_to }}" class="nav-btn">다음</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}
